```table-of-contents
```

### Как работает SSH

SSH работает по клиент-серверной модели. Сотрудник компании (например, системный администратор) — клиент. Сервер — удалённая машина. Вот как работает протокол SSH пошагово:

**1. Инициализация соединения**  
Клиент отправляет запрос на соединение с SSH-сервером по определённому порту. По умолчанию это порт 22. Сервер принимает запрос и начинает процесс установки соединения.

**2. Обмен ключами**  
- Сервер отправляет свою публичную ключевую пару клиенту. Публичный ключ используется для шифрования данных, которые могут быть расшифрованы только с помощью соответствующего приватного ключа, который хранится на сервере и защищён от несанкционированного доступа.  
- Клиент генерирует случайное число и шифрует его с помощью полученного публичного ключа сервера.

**3. Аутентификация клиента**  
- Клиент отправляет зашифрованный сессионный ключ на сервер.  
- Сервер расшифровывает сессионный ключ с помощью своего приватного ключа.  
- На основе сессионного ключа создаётся симметричный алгоритм [шифрования](https://practicum.yandex.ru/blog/chto-takoe-shifrovanie-informacii/), который будет использоваться для шифрования и дешифрования данных в обоих направлениях.

**4. Проверка подлинности клиента**  
- Клиент может аутентифицироваться на сервере разными способами, например с помощью пароля или SSH-ключей.  
- Если используются SSH-ключи, клиент отправляет свой публичный ключ на сервер, а сервер проверяет его наличие в списке разрешённых ключей.  
- При использовании парольной аутентификации клиент отправляет пароль, который проверяет сервер.

**5. Установление защищённого канала**  
После успешной аутентификации клиента сервер и клиент начинают использовать симметричный алгоритм шифрования для обмена данными.  
  
**6. Работа с удалённым сервером**  
После установки защищённого соединения клиент может выполнять различные команды на удалённом сервере, передавать файлы.  
  
**7. Завершение соединения**  
- Когда клиент завершает работу с сервером, соединение закрывается.  
- Сессионный ключ уничтожается, и все защищённые данные становятся недоступными для расшифровки без этого ключа.

### Установка и настройка SSH

#### На стороне сервера Linux

```sh
sudo apt update  
sudo apt install openssh-server
sudo systemctl status ssh
```

#### На стороне клиента Linux

```shell
sudo apt install openssh-client
```

### Первое подключение

При первом подключении к серверу SSH спросит: 
> The authenticity of host 'ip (ip)' can't be established. Are you sure you want to continue connecting (yes/no/\[fingerprint])?

Это сообщение появляется при первом подключении к серверу, так как `fingerprint` сервера не был сохранён в `~/.ssh/known_hosts`у клиента.

После подтверждения (`yes`) SSH сохранит `fingerprint` сервера в `~/.ssh/known_hosts`. 
При следующих подключениях система будет сравнивать его с текущим, чтобы избежать атак типа _man-in-the-middle_.**

### Подключение

Прежде чем подключиться к серверу по SSH, нужно выяснить несколько параметров:  
- **IP-адрес** или **доменное имя** сервера (например, 192.168.1.100 или example.com)  
- **имя пользователя** на сервере (например, admin)  
- **порт** подключения (по умолчанию 22, но может быть другим)
- **пароль** или **настроенный SSH-ключ**.

Когда данные известны, можно подключаться. Базовая команда для подключения:
```shell
ssh username@server_ip
```

Если используется нестандартный порт (например, 2222):  
```shell
ssh -p 2222 username@server_ip
```

Если нужно нужно указать определенный приватный ключ:
```shell
ssh -i ~/.ssh/id_rsa username@server_ip
```

### Генерация пары ключей

```sh
ssh-keygen -t rsa -C "<user>@<machine>" -b 4096
```

### Отправка публичного ключа на сервер

Для отправки публичного ключа на сервер для входа без пароля можно использовать следующую команду:
```shell
ssh-copy-id username@server_ip
```

Если используется нестандартный порт (например, 2222):  
```shell
ssh -p 2222 username@server_ip
```

Если нужно нужно указать определенный публичный ключ для копирования:
```shell
ssh-copy-id -i ~/.ssh/id_rsa.pub username@server_ip
```

### Копирование файлов между локальной машиной и сервером

Команда `scp` (Secure Copy Protocol) позволяет копировать файлы между локальной машиной и удалённым сервером по SSH. Она работает аналогично `cp`, но поддерживает передачу данных через зашифрованное соединение.

Синтаксис:
```sh
scp [опции] исходный_файл целевой_путь
```

Копирование с локальной машины на сервер:
```sh
scp /путь/к/локальному/файлу username@сервер:/путь/на/сервере
```

Копирование с сервера на локальную машину:
```sh
scp username@сервер:/путь/к/файлу /локальный/путь
```

Копирование директорий (рекурсивно):
```sh
scp -r /локальная/папка user@example.com:/удалённый/путь
```

Порт SSH (если не стандартный 22):
```sh
scp -P 2222 /путь/к/локальному/файлу user@example.com:/tmp/
```

Сжатие данных при передаче (опция `-C`):
```sh
scp -i ~/.ssh/private_key file.txt user@example.com:/tmp/
```

### Упрощение подключений к серверам с ~/.ssh/config

Файл `~/.ssh/config` позволяет настраивать параметры SSH-клиента, упрощая подключение к серверам. В этом файле можно задавать алиасы, порты, SSH-ключи и другие параметры для разных хостов.

Файл `config` должен иметь права `600` (только чтение/запись владельцем):
```sh
chmod 600 ~/.ssh/config
```

Основной синтаксис:
```sh
Host myalias                        # Произвольное имя для подключения
    HostName example.com            # Реальный адрес сервера (IP или домен)
    User admin                      # Имя пользователя
    Port 2222                       # Порт SSH (если не стандартный 22)
    IdentityFile ~/.ssh/private_key # Путь к SSH-ключу
    ForwardAgent yes                # Включить SSH Agent Forwarding
    ProxyJump jump-server           # Подключение через промежуточный сервер
```

Настройки по умолчанию для всех хостов:
```sh
Host *
    User mydefaultuser
    IdentityFile ~/.ssh/private_key
    StrictHostKeyChecking no  # Автоматически добавлять хосты в known_hosts
    ServerAliveInterval 60    # Поддерживать соединение активным
```

Использование:
```sh
ssh myalias  # вместо `ssh admin@example.com -p 2222`
```

### SSH Agent

**SSH Agent** — это фоновый процесс (демон), который управляет вашими **приватными SSH-ключами** в зашифрованном виде и предоставляет их для аутентификации при подключении к серверам.

Основные функции:
- **Хранение ключей в памяти** (не нужно постоянно вводить пароль от ключа).
- **Автоматическая аутентификация** при использовании `ssh`, `scp`, `git` и других SSH-клиентов.
- **Безопасность**: приватные ключи никогда не передаются напрямую, только подписывают запросы.

Как работает SSH Agent:
1. Вы запускаете `ssh-agent` (обычно он стартует автоматически в современных системах).
2. Добавляете ключи командой `ssh-add ~/.ssh/id_rsa`.
3. При подключении к серверу (`ssh user@host`), `ssh-agent` подставляет ключ без запроса пароля.

Проверка работы:
```sh
echo $SSH_AUTH_SOCK  # Должен вывести путь к сокету агента
ssh-add -l           # Список ключей (их хэши)
ssh-add -L           # Показать полные ключи (в формате для authorized_keys)
```

Пример работы без агента:
```sh
ssh -i ~/.ssh/key user@example.com  # Каждый раз указывать ключ
```

Пример работы c агентом:
```sh
ssh-add ~/.ssh/key   # Добавили ключ один раз
ssh user@example.com # Больше не нужно указывать ключ
```

Ключи, добавленные через `ssh-add`, хранятся в памяти до тех пор, пока:
1. Вы не закроете сессию терминала (если агент был запущен в ней)
2. Не перезагрузите компьютер (агент завершает работу).
3. Не убьёте процесс ssh-agent вручную (pkill ssh-agent).
4. Не истечёт таймаут (если он задан).

